# Optimized AI-Powered Agriculture Application Code
from tkinter import *
from tkinter import filedialog, simpledialog
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import os
import pickle
from keras.models import Sequential, model_from_json
from keras.layers import Dense, Dropout, Flatten
from keras.utils.np_utils import to_categorical
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import LabelEncoder, StandardScaler
import keras.layers

main = Tk()
main.title("AI- Powered agriculture optimization using machine learning")
main.geometry("1000x650")
main.config(bg='light coral')

# Global Variables
filename = ""
rnn_acc = lstm_acc = ff_acc = 0
classifier = None
X = Y = Y1 = None
rainfall_dataset = crop_dataset = None
le = LabelEncoder()
scalerX = StandardScaler()
weight_for_0 = weight_for_1 = 0

# Upload Dataset
def upload():
    global filename, rainfall_dataset, crop_dataset
    filename = filedialog.askdirectory(initialdir=".")
    rainfall_dataset = pd.read_csv('dataset/district wise rainfall normal.csv')
    crop_dataset = pd.read_csv('dataset/Agriculture In India.csv')
    crop_dataset.fillna(0, inplace=True)
    crop_dataset['Production'] = crop_dataset['Production'].astype(np.int64)
    text.delete('1.0', END)
    text.insert(END, filename + ' Loaded\n\n')
    text.insert(END, str(crop_dataset.head()))

# Preprocess Dataset
def preprocess():
    global X, Y, weight_for_0, weight_for_1, crop_dataset
    text.delete('1.0', END)

    for col in ['State_Name', 'District_Name', 'Season', 'Crop']:
        crop_dataset[col] = le.fit_transform(crop_dataset[col])

    data = crop_dataset.values
    X = data[:, :-1]
    Y = data[:, -1].astype('uint8')

    avg = np.average(Y)
    Y = np.array([1 if y >= avg else 0 for y in Y]).astype('uint8')
    Y = to_categorical(Y)

    counts = np.bincount(Y[:, 0])
    weight_for_0 = 1.0 / counts[0]
    weight_for_1 = 1.0 / counts[1]

    scalerX.fit(X)
    X = scalerX.transform(X)
    text.insert(END, str(X))

# Run RNN Algorithm
def runRNN():
    global rnn_acc, classifier
    text.delete('1.0', END)

    if os.path.exists('model/rnnmodel.json'):
        with open('model/rnnmodel.json', "r") as json_file:
            classifier = model_from_json(json_file.read())
        classifier.load_weights("model/rnnmodel_weights.h5")
        f = open('model/rnnhistory.pckl', 'rb')
        rnn_acc = pickle.load(f)[1] * 100
        f.close()
    else:
        rnn = Sequential([
            Dense(256, input_dim=X.shape[1], activation='relu'),
            Dense(128, activation='relu'),
            Dense(Y.shape[1], activation='softmax')
        ])
        rnn.compile(loss='binary_crossentropy', optimizer='adam', metrics=['accuracy'])
        history = rnn.fit(X, Y, epochs=2, batch_size=64, class_weight={0: weight_for_0, 1: weight_for_1})
        rnn_acc = history.history['accuracy'][1] * 100
        with open('model/rnnhistory.pckl', 'wb') as f:
            pickle.dump(history.history['accuracy'], f)
        rnn.save_weights('model/rnnmodel_weights.h5')
        with open("model/rnnmodel.json", "w") as json_file:
            json_file.write(rnn.to_json())
        classifier = rnn

    text.insert(END, f'RNN Prediction Accuracy : {rnn_acc}\n\n')

# Run LSTM Algorithm
def runLSTM():
    global lstm_acc
    if os.path.exists('model/lstmmodel.json'):
        with open('model/lstmmodel.json', "r") as json_file:
            classifier1 = model_from_json(json_file.read())
        classifier1.load_weights("model/lstmmodel_weights.h5")
        with open('model/lstmhistory.pckl', 'rb') as f:
            lstm_acc = pickle.load(f)[1] * 100
    else:
        XX = X.reshape((X.shape[0], X.shape[1], 1))
        model = Sequential([
            keras.layers.LSTM(512, input_shape=(X.shape[1], 1)),
            Dropout(0.5),
            Dense(256, activation='relu'),
            Dense(Y.shape[1], activation='softmax')
        ])
        model.compile(loss='categorical_crossentropy', optimizer='adam', metrics=['accuracy'])
        history = model.fit(XX, Y, epochs=2, batch_size=64)
        lstm_acc = history.history['accuracy'][1] * 100
        with open('model/lstmhistory.pckl', 'wb') as f:
            pickle.dump(history.history['accuracy'], f)
        model.save_weights('model/lstmmodel_weights.h5')
        with open("model/lstmmodel.json", "w") as json_file:
            json_file.write(model.to_json())

    text.insert(END, f'LSTM Prediction Accuracy : {lstm_acc}\n\n')

# Run Feed Forward NN

def runFF():
    global ff_acc
    model = Sequential([
        Dense(64, activation='relu', input_shape=(X.shape[1],)),
        Dense(64, activation='relu'),
        Dense(2, activation='softmax')
    ])
    model.compile(optimizer='adam', loss='categorical_crossentropy', metrics=['accuracy'])
    history = model.fit(X, Y, epochs=2, batch_size=64)
    ff_acc = history.history['accuracy'][1] * 100
    text.insert(END, f'Feed Forward Neural Network Prediction Accuracy : {ff_acc}\n\n')

# Predict Crop Yield
def predict():
    global classifier
    text.delete('1.0', END)
    file = filedialog.askopenfilename(initialdir="dataset")
    test = pd.read_csv(file)
    for col in ['State_Name', 'District_Name', 'Season', 'Crop']:
        test[col] = le.fit_transform(test[col])
    scalerX = MinMaxScaler()
    scalerX.fit(X_train)
    y_pred = classifier.predict(test)
    for i, sample in enumerate(test):
        pred = np.argmax(y_pred[i])
        label = 'Predicted Crop Yield will be HIGH' if pred == 1 else 'Predicted Crop Yield will be LESS'
        text.insert(END, f"X={sample}, Predicted = {label}\n\n")

# Graph Functions
def graph():
    bars = ['RNN Accuracy', 'LSTM Accuracy', 'Feed Forward Accuracy']
    height = [rnn_acc, lstm_acc, ff_acc]
    plt.bar(range(len(bars)), height)
    plt.xticks(range(len(bars)), bars)
    plt.show()

def pieChart():
    global crop_dataset
    crop_data = crop_dataset.groupby('Crop')['Production'].sum().sort_values(ascending=False)[:6]
    plt.figure(figsize=(8, 8))
    plt.pie(crop_data, labels=crop_data.index, autopct='%1.1f%%',
            startangle=140, colors=['gold', 'lightcoral', 'lightskyblue', 'yellowgreen', 'violet', 'orange'])
    plt.title("Top 6 Crops by Production")
    plt.show()

def topGraph():
    rainfall = rainfall_dataset.groupby(['STATE_UT_NAME'])['ANNUAL'].sum().sort_values(ascending=False).reset_index().values[:6]
    x1, y1 = rainfall[:, 0], rainfall[:, 1]

    crop = pd.read_csv('dataset/Agriculture In India.csv')
    crop.fillna(0, inplace=True)
    crop['Production'] = crop['Production'].astype(np.int64)
    crop = crop.groupby(['State_Name', 'Crop'])['Production'].sum().reset_index()
    crop_sorted = crop.sort_values("Production", ascending=False).values

    def get_top_states(crop_name):
        return [(row[0], row[2]) for row in crop_sorted if row[1] == crop_name][:6]

    graphs = [('State Vs Rainfall', x1, y1),
              ('Top 6 State Vs Rice Crop Yield', *zip(*get_top_states('Rice'))),
              ('Top 6 State Vs Coconut Crop Yield', *zip(*get_top_states('Coconut'))),
              ('Top 6 State Vs Sugarcane Crop Yield', *zip(*get_top_states('Sugarcane'))),
              ('Top 6 State Vs Any Crop Yield', *zip(*crop_sorted[:6, [0, 2]]))]

    fig, axs = plt.subplots(5, figsize=(10, 15))
    fig.suptitle('Top 6 State Rainfall & Crop Yield')
    for i, (title, x, y) in enumerate(graphs):
        axs[i].plot(x, y)
        axs[i].set_title(title)
    plt.tight_layout()
    plt.show()

# UI Elements
font = ('times', 15, 'bold')
title = Label(main, text='AI- Powered agriculture optimization using machine learning', bg='wheat3', fg='navy', font=font)
title.pack(pady=10)

font1 = ('times', 12, 'bold')
Button(main, text="Upload Agriculture Dataset", command=upload, font=font1).place(x=10, y=100)
Button(main, text="Preprocess Dataset", command=preprocess, font=font1).place(x=300, y=100)
Button(main, text="Run RNN Algorithm", command=runRNN, font=font1).place(x=480, y=100)
Button(main, text="Run LSTM Algorithm", command=runLSTM, font=font1).place(x=670, y=100)
Button(main, text="Run Feedforward Neural Network", command=runFF, font=font1).place(x=10, y=150)
Button(main, text="Accuracy Comparison Graph", command=graph, font=font1).place(x=300, y=150)
Button(main, text="Top 6 Crop Yield Graph", command=topGraph, font=font1).place(x=10, y=200)
Button(main, text="Show Crop Yield Pie Chart", command=pieChart, font=font1).place(x=670, y=150)

text = Text(main, height=20, width=160, bg='white', fg='black', font=font1)
text.place(x=10, y=250)
scroll = Scrollbar(text)
text.configure(yscrollcommand=scroll.set)

main.mainloop()
